openapi: 3.0.3
info:
  title: PFA - Personal Finance Awareness API
  description: |
    API for the Personal Finance Awareness application. Provides endpoints for
    authentication, transaction management, categorization, and dashboard data.
  version: 1.0.0
  contact:
    name: PFA Support

servers:
  - url: https://pfa.evehwang.com/api
    description: Production API
  - url: http://localhost:3000/api
    description: Local development

tags:
  - name: Auth
    description: Authentication endpoints
  - name: Transactions
    description: Transaction management
  - name: Categories
    description: Category management
  - name: Rules
    description: Auto-categorization rules
  - name: Budgets
    description: Budget management
  - name: Dashboard
    description: Dashboard and analytics

paths:
  # Authentication
  /auth/login:
    post:
      tags: [Auth]
      summary: Authenticate user
      description: Validates password and returns JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [password]
              properties:
                password:
                  type: string
                  format: password
                  description: User password
      responses:
        "200":
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT token (24-hour expiry)
                  expires_at:
                    type: string
                    format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/verify:
    get:
      tags: [Auth]
      summary: Verify token validity
      description: Checks if the current JWT token is valid
      operationId: verifyToken
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  expires_at:
                    type: string
                    format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"

  # Dashboard
  /dashboard:
    get:
      tags: [Dashboard]
      summary: Get dashboard summary data
      description: Returns all data needed to render the dashboard
      operationId: getDashboard
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/startDate"
        - $ref: "#/components/parameters/endDate"
        - $ref: "#/components/parameters/accountId"
      responses:
        "200":
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DashboardData"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # Transactions
  /transactions:
    get:
      tags: [Transactions]
      summary: List transactions
      description: Returns paginated list of transactions with optional filters
      operationId: listTransactions
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/startDate"
        - $ref: "#/components/parameters/endDate"
        - $ref: "#/components/parameters/accountId"
        - name: category_id
          in: query
          schema:
            type: integer
          description: Filter by category
        - name: needs_review
          in: query
          schema:
            type: boolean
          description: Filter by review status
        - name: search
          in: query
          schema:
            type: string
          description: Search in description
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [date, amount, description]
            default: date
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        "200":
          description: List of transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/TransactionSummary"
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        "401":
          $ref: "#/components/responses/Unauthorized"

  /transactions/upload:
    post:
      tags: [Transactions]
      summary: Upload CSV file
      description: |
        Uploads and processes a CSV file from Bank of America.
        Automatically detects format (Credit Card vs Checking/Savings).
      operationId: uploadTransactions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, account_id]
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file (max 5MB)
                account_id:
                  type: string
                  enum: [checking, savings, credit]
                  description: Target account
      responses:
        "200":
          description: Upload processed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /transactions/{id}:
    get:
      tags: [Transactions]
      summary: Get transaction by ID
      operationId: getTransaction
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Transaction details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionSummary"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [Transactions]
      summary: Update transaction
      description: Update category or other editable fields
      operationId: updateTransaction
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                category_id:
                  type: integer
                  nullable: true
                needs_review:
                  type: boolean
      responses:
        "200":
          description: Transaction updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionSummary"
        "404":
          $ref: "#/components/responses/NotFound"

  /transactions/review:
    get:
      tags: [Transactions]
      summary: Get transactions needing review
      description: Returns uncategorized transactions
      operationId: getReviewQueue
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        "200":
          description: Review queue
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/TransactionSummary"
                  total:
                    type: integer

  /transactions/review/batch:
    post:
      tags: [Transactions]
      summary: Batch categorize transactions
      description: Update multiple transactions at once
      operationId: batchCategorize
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [updates]
              properties:
                updates:
                  type: array
                  items:
                    type: object
                    required: [id, category_id]
                    properties:
                      id:
                        type: string
                        format: uuid
                      category_id:
                        type: integer
                create_rules:
                  type: array
                  items:
                    type: object
                    required: [pattern, category_id]
                    properties:
                      pattern:
                        type: string
                      category_id:
                        type: integer
      responses:
        "200":
          description: Batch update successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated_count:
                    type: integer
                  rules_created:
                    type: integer

  /export:
    get:
      tags: [Transactions]
      summary: Export transactions as CSV
      description: Downloads filtered transactions as CSV file
      operationId: exportTransactions
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/startDate"
        - $ref: "#/components/parameters/endDate"
        - $ref: "#/components/parameters/accountId"
        - name: category_id
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: CSV file
          content:
            text/csv:
              schema:
                type: string
                format: binary

  # Categories
  /categories:
    get:
      tags: [Categories]
      summary: List all categories
      operationId: listCategories
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of categories
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Category"

    post:
      tags: [Categories]
      summary: Create category
      operationId: createCategory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoryInput"
      responses:
        "201":
          description: Category created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Category"
        "400":
          $ref: "#/components/responses/BadRequest"

  /categories/{id}:
    patch:
      tags: [Categories]
      summary: Update category
      operationId: updateCategory
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoryInput"
      responses:
        "200":
          description: Category updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Category"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [Categories]
      summary: Delete category
      description: Only allowed if no transactions use this category
      operationId: deleteCategory
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Category deleted
        "400":
          description: Category in use
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          $ref: "#/components/responses/NotFound"

  # Categorization Rules
  /rules:
    get:
      tags: [Rules]
      summary: List categorization rules
      operationId: listRules
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of rules
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/CategorizationRule"

    post:
      tags: [Rules]
      summary: Create categorization rule
      operationId: createRule
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RuleInput"
      responses:
        "201":
          description: Rule created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategorizationRule"

  /rules/{id}:
    patch:
      tags: [Rules]
      summary: Update rule
      operationId: updateRule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RuleInput"
      responses:
        "200":
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategorizationRule"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [Rules]
      summary: Delete rule
      operationId: deleteRule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Rule deleted
        "404":
          $ref: "#/components/responses/NotFound"

  # Budgets
  /budgets:
    get:
      tags: [Budgets]
      summary: List budgets
      operationId: listBudgets
      security:
        - bearerAuth: []
      parameters:
        - name: month
          in: query
          schema:
            type: string
            pattern: "^\\d{4}-\\d{2}$"
          description: Filter by month (YYYY-MM)
      responses:
        "200":
          description: List of budgets with actual spending
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/BudgetSummary"

    post:
      tags: [Budgets]
      summary: Create or update budget
      description: Upserts budget for category/month combination
      operationId: upsertBudget
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BudgetInput"
      responses:
        "200":
          description: Budget saved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Budget"

  /budgets/{id}:
    delete:
      tags: [Budgets]
      summary: Delete budget
      operationId: deleteBudget
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Budget deleted
        "404":
          $ref: "#/components/responses/NotFound"

  # Accounts
  /accounts:
    get:
      tags: [Dashboard]
      summary: List accounts
      operationId: listAccounts
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Account"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    startDate:
      name: start_date
      in: query
      schema:
        type: string
        format: date
      description: Filter start date (YYYY-MM-DD)

    endDate:
      name: end_date
      in: query
      schema:
        type: string
        format: date
      description: Filter end date (YYYY-MM-DD)

    accountId:
      name: account_id
      in: query
      schema:
        type: string
        enum: [checking, savings, credit]
      description: Filter by account

  schemas:
    # Core entities
    Account:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        account_type:
          type: string
          enum: [checking, savings, credit]

    Category:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        category_type:
          type: string
          enum: [income, expense, transfer]
        parent_id:
          type: integer
          nullable: true
        parent_name:
          type: string
          nullable: true
        display_order:
          type: integer

    CategoryInput:
      type: object
      required: [name, category_type]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        category_type:
          type: string
          enum: [income, expense, transfer]
        parent_id:
          type: integer
          nullable: true
        display_order:
          type: integer
          default: 0

    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        account_id:
          type: string
        date:
          type: string
          format: date
        description:
          type: string
        amount:
          type: number
          format: decimal
        category_id:
          type: integer
          nullable: true
        needs_review:
          type: boolean
        hash:
          type: string
        created_at:
          type: string
          format: date-time

    TransactionSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        date:
          type: string
          format: date
        description:
          type: string
        amount:
          type: number
        needs_review:
          type: boolean
        account_id:
          type: string
        account_name:
          type: string
        category_id:
          type: integer
          nullable: true
        category_name:
          type: string
          nullable: true
        parent_category_name:
          type: string
          nullable: true

    CategorizationRule:
      type: object
      properties:
        id:
          type: integer
        pattern:
          type: string
        category_id:
          type: integer
        category_name:
          type: string
        priority:
          type: integer
        account_filter:
          type: string
          nullable: true
        is_active:
          type: boolean

    RuleInput:
      type: object
      required: [pattern, category_id]
      properties:
        pattern:
          type: string
          minLength: 1
        category_id:
          type: integer
        priority:
          type: integer
          default: 100
        account_filter:
          type: string
          nullable: true
        is_active:
          type: boolean
          default: true

    Budget:
      type: object
      properties:
        id:
          type: integer
        category_id:
          type: integer
        monthly_amount:
          type: number
        effective_date:
          type: string
          format: date

    BudgetInput:
      type: object
      required: [category_id, monthly_amount, effective_date]
      properties:
        category_id:
          type: integer
        monthly_amount:
          type: number
          minimum: 0
        effective_date:
          type: string
          format: date
          description: First day of the month (YYYY-MM-01)

    BudgetSummary:
      type: object
      properties:
        id:
          type: integer
        category_id:
          type: integer
        category_name:
          type: string
        budget_amount:
          type: number
        actual_spent:
          type: number
        remaining:
          type: number
        percent_used:
          type: number

    # Dashboard data
    DashboardData:
      type: object
      properties:
        summary:
          type: object
          properties:
            net_worth:
              type: number
            net_worth_change:
              type: number
            monthly_spending:
              type: number
            previous_month_spending:
              type: number
            top_category:
              type: string
            top_category_amount:
              type: number
            pending_review_count:
              type: integer
        spending_by_category:
          type: array
          items:
            type: object
            properties:
              category_id:
                type: integer
              category_name:
                type: string
              amount:
                type: number
              percentage:
                type: number
        monthly_trend:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              income:
                type: number
              expenses:
                type: number
        recent_transactions:
          type: array
          items:
            $ref: "#/components/schemas/TransactionSummary"

    # Upload result
    UploadResult:
      type: object
      properties:
        new_count:
          type: integer
          description: Number of new transactions added
        duplicate_count:
          type: integer
          description: Number of duplicate transactions skipped
        review_count:
          type: integer
          description: Number of transactions needing review
        errors:
          type: array
          items:
            type: object
            properties:
              row:
                type: integer
              message:
                type: string

    # Error response
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Invalid input"
            code: "BAD_REQUEST"

    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Authentication required"
            code: "UNAUTHORIZED"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Resource not found"
            code: "NOT_FOUND"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
